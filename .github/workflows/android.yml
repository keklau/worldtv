name: WorldTV – build auto (profils + M3U + Xtream LIVE)

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # On fige Gradle 8.7 (stable avec AGP 8.5.2)
      - name: Set up Gradle 8.7
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: 8.7
          cache-read-only: true

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # >>> ICI on génère TOUT le projet Android <<<
      - name: Generate Android project
        run: |
          set -e
          mkdir -p app/src/main/java/com/worldtv/xtream
          mkdir -p app/src/main/java/com/worldtv
          mkdir -p app/src/main/res/layout
          mkdir -p app/src/main/res/values

          # settings.gradle
          cat > settings.gradle <<'EOF'
          pluginManagement { repositories { gradlePluginPortal(); google(); mavenCentral() } }
          dependencyResolutionManagement {
            repositoriesMode.set(RepositoriesMode.PREFER_SETTINGS)
            repositories { google(); mavenCentral() }
          }
          rootProject.name = "worldtv"
          include(":app")
          EOF

          # build.gradle (root)
          echo "// generated" > build.gradle

          # app/build.gradle (AGP 8.5.2, SDK 34, Media3)
          cat > app/build.gradle <<'EOF'
          plugins { id 'com.android.application' version '8.5.2' }
          android {
            namespace "com.worldtv"
            compileSdk 34
            defaultConfig { applicationId "com.worldtv"; minSdk 21; targetSdk 34; versionCode 1; versionName "1.0" }
            buildTypes { release { minifyEnabled false } }
            compileOptions { sourceCompatibility JavaVersion.VERSION_17; targetCompatibility JavaVersion.VERSION_17 }
          }
          dependencies {
            implementation 'androidx.appcompat:appcompat:1.6.1'
            implementation 'com.google.android.material:material:1.9.0'
            implementation 'androidx.media3:media3-exoplayer:1.4.1'
            implementation 'androidx.media3:media3-exoplayer-hls:1.4.1'
            implementation 'androidx.media3:media3-ui:1.4.1'
          }
          EOF

          # Manifest
          cat > app/src/main/AndroidManifest.xml <<'EOF'
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">
            <uses-permission android:name="android.permission.INTERNET"/>
            <application android:label="World TV" android:theme="@style/Theme.Material3.DayNight.NoActionBar">
              <activity android:name=".ProfilesActivity" android:exported="true">
                <intent-filter>
                  <action android:name="android.intent.action.MAIN"/>
                  <category android:name="android.intent.category.LAUNCHER"/>
                </intent-filter>
              </activity>
              <activity android:name=".AddM3UActivity" android:exported="false"/>
              <activity android:name=".AddXtreamActivity" android:exported="false"/>
              <activity android:name=".AddStbActivity" android:exported="false"/>
              <activity android:name=".M3UChannelListActivity" android:exported="false"/>
              <activity android:name=".xtream.XtreamLiveCategoriesActivity" android:exported="false"/>
              <activity android:name=".xtream.XtreamLiveChannelsActivity" android:exported="false"/>
              <activity android:name=".PlayerActivity" android:exported="false"/>
            </application>
          </manifest>
          EOF

          # Layouts (profils, adders, listes, player)
          cat > app/src/main/res/layout/activity_profiles.xml <<'EOF'
          <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:orientation="vertical" android:padding="16dp"
              android:layout_width="match_parent" android:layout_height="match_parent">
              <LinearLayout android:orientation="horizontal"
                  android:layout_width="match_parent" android:layout_height="wrap_content">
                  <Button android:id="@+id/btn_add_m3u" android:text="+ M3U"
                      android:layout_width="0dp" android:layout_weight="1" android:layout_height="wrap_content"/>
                  <Button android:id="@+id/btn_add_xtream" android:text="+ Xtream"
                      android:layout_width="0dp" android:layout_weight="1" android:layout_height="wrap_content"
                      android:layout_marginStart="8dp"/>
                  <Button android:id="@+id/btn_add_stb" android:text="+ STB"
                      android:layout_width="0dp" android:layout_weight="1" android:layout_height="wrap_content"
                      android:layout_marginStart="8dp"/>
              </LinearLayout>
              <TextView android:text="Profils (appui long pour supprimer)"
                  android:layout_width="match_parent" android:layout_height="wrap_content" android:paddingTop="12dp"/>
              <ListView android:id="@+id/list_profiles" android:layout_width="match_parent"
                  android:layout_height="0dp" android:layout_weight="1"/>
          </LinearLayout>
          EOF

          cat > app/src/main/res/layout/activity_add_m3u.xml <<'EOF'
          <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:orientation="vertical" android:padding="16dp"
              android:layout_width="match_parent" android:layout_height="match_parent">
              <EditText android:id="@+id/ed_name" android:hint="Nom du profil"
                  android:layout_width="match_parent" android:layout_height="wrap_content"/>
              <EditText android:id="@+id/ed_url" android:hint="URL M3U/M3U8" android:inputType="textUri"
                  android:layout_width="match_parent" android:layout_height="wrap_content"/>
              <Button android:id="@+id/btn_save" android:text="Enregistrer"
                  android:layout_width="match_parent" android:layout_height="wrap_content" android:layout_marginTop="12dp"/>
          </LinearLayout>
          EOF

          cat > app/src/main/res/layout/activity_add_xtream.xml <<'EOF'
          <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:orientation="vertical" android:padding="16dp"
              android:layout_width="match_parent" android:layout_height="match_parent">
              <EditText android:id="@+id/ed_name" android:hint="Nom du profil"
                  android:layout_width="match_parent" android:layout_height="wrap_content"/>
              <EditText android:id="@+id/ed_host" android:hint="http://host:port" android:inputType="textUri"
                  android:layout_width="match_parent" android:layout_height="wrap_content"/>
              <EditText android:id="@+id/ed_user" android:hint="username"
                  android:layout_width="match_parent" android:layout_height="wrap_content"/>
              <EditText android:id="@+id/ed_pass" android:hint="password" android:inputType="textPassword"
                  android:layout_width="match_parent" android:layout_height="wrap_content"/>
              <Button android:id="@+id/btn_save" android:text="Enregistrer"
                  android:layout_width="match_parent" android:layout_height="wrap_content" android:layout_marginTop="12dp"/>
          </LinearLayout>
          EOF

          cat > app/src/main/res/layout/activity_add_stb.xml <<'EOF'
          <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:orientation="vertical" android:padding="16dp"
              android:layout_width="match_parent" android:layout_height="match_parent">
              <EditText android:id="@+id/ed_name" android:hint="Nom du profil"
                  android:layout_width="match_parent" android:layout_height="wrap_content"/>
              <EditText android:id="@+id/ed_portal" android:hint="http://host/stalker_portal/" android:inputType="textUri"
                  android:layout_width="match_parent" android:layout_height="wrap_content"/>
              <EditText android:id="@+id/ed_mac" android:hint="MAC (ex: 00:1A:79:xx:xx:xx)"
                  android:layout_width="match_parent" android:layout_height="wrap_content"/>
              <Button android:id="@+id/btn_save" android:text="Enregistrer"
                  android:layout_width="match_parent" android:layout_height="wrap_content" android:layout_marginTop="12dp"/>
          </LinearLayout>
          EOF

          cat > app/src/main/res/layout/activity_channel_list.xml <<'EOF'
          <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:orientation="vertical" android:padding="0dp"
              android:layout_width="match_parent" android:layout_height="match_parent">
              <ListView android:id="@+id/list" android:layout_width="match_parent" android:layout_height="match_parent"/>
          </LinearLayout>
          EOF

          cat > app/src/main/res/layout/activity_player.xml <<'EOF'
          <FrameLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:layout_width="match_parent" android:layout_height="match_parent">
              <androidx.media3.ui.PlayerView
                  android:id="@+id/player_view"
                  android:layout_width="match_parent"
                  android:layout_height="match_parent"/>
          </FrameLayout>
          EOF

          # strings
          echo '<resources><string name="app_name">World TV</string></resources>' \
            > app/src/main/res/values/strings.xml

          # ---------- Java utils ----------
          cat > app/src/main/java/com/worldtv/ProfileManager.java <<'EOF'
          package com.worldtv;
          import android.content.*; import org.json.*;
          public class ProfileManager {
            private static final String PREF="worldtv_profiles", KEY="profiles_json";
            public static JSONArray load(Context c){
              String s=c.getSharedPreferences(PREF,0).getString(KEY,"[]");
              try{return new JSONArray(s);}catch(Exception e){return new JSONArray();}
            }
            public static void save(Context c, JSONArray a){
              c.getSharedPreferences(PREF,0).edit().putString(KEY,a.toString()).apply();
            }
            public static void addProfile(Context c, JSONObject o){
              JSONArray a=load(c); a.put(o); save(c,a);
            }
            public static void removeById(Context c,long id){
              JSONArray a=load(c),b=new JSONArray();
              for(int i=0;i<a.length();i++){ JSONObject o=a.optJSONObject(i);
                if(o!=null && o.optLong("id",-1)!=id) b.put(o);}
              save(c,b);
            }
          }
          EOF

          cat > app/src/main/java/com/worldtv/M3UParser.java <<'EOF'
          package com.worldtv;
          import java.util.*;
          public class M3UParser {
            public static ArrayList<String[]> parse(String t){
              ArrayList<String[]> out=new ArrayList<>(); String name=null;
              for(String L:t.split("\\r?\\n")){
                L=L.trim();
                if(L.startsWith("#EXTINF:")){ int k=L.indexOf(","); name=(k>=0&&k+1<L.length())?L.substring(k+1).trim():"Sans nom";}
                else if(!L.isEmpty() && !L.startsWith("#")){ out.add(new String[]{name==null?"Sans nom":name,L}); name=null; }
              }
              return out;
            }
          }
          EOF

          # ---------- Activities noyau ----------
          cat > app/src/main/java/com/worldtv/ProfilesActivity.java <<'EOF'
          package com.worldtv;
          import android.app.*; import android.os.*; import android.content.*; import android.widget.*; import org.json.*; import java.util.*;
          public class ProfilesActivity extends Activity {
            ListView list; JSONArray data;
            protected void onCreate(Bundle b){ super.onCreate(b); setContentView(R.layout.activity_profiles);
              list=findViewById(R.id.list_profiles);
              findViewById(R.id.btn_add_m3u).setOnClickListener(v->startActivity(new Intent(this,AddM3UActivity.class)));
              findViewById(R.id.btn_add_xtream).setOnClickListener(v->startActivity(new Intent(this,AddXtreamActivity.class)));
              findViewById(R.id.btn_add_stb).setOnClickListener(v->startActivity(new Intent(this,AddStbActivity.class)));
              list.setOnItemClickListener((a,v,pos,id)->open(pos));
              list.setOnItemLongClickListener((a,v,pos,id)->{del(pos); return true;});
            }
            protected void onResume(){ super.onResume(); refresh(); }
            void refresh(){ data=ProfileManager.load(this);
              ArrayList<String> names=new ArrayList<>();
              for(int i=0;i<data.length();i++){ JSONObject o=data.optJSONObject(i);
                names.add(o.optString("type","?")+" • "+o.optString("name","Sans nom")); }
              list.setAdapter(new ArrayAdapter<>(this,android.R.layout.simple_list_item_1,names));
            }
            void open(int pos){ JSONObject o=data.optJSONObject(pos); if(o==null)return;
              String type=o.optString("type","");
              if("M3U".equals(type)){ Intent i=new Intent(this,M3UChannelListActivity.class); i.putExtra("url",o.optString("url","")); startActivity(i); }
              else if("XTREAM".equals(type)){ Intent i=new Intent(this,com.worldtv.xtream.XtreamLiveCategoriesActivity.class);
                i.putExtra("host",o.optString("host","")); i.putExtra("user",o.optString("user","")); i.putExtra("pass",o.optString("pass","")); startActivity(i); }
              else if("STB".equals(type)){ Toast.makeText(this,"STB: à venir",Toast.LENGTH_SHORT).show(); }
            }
            void del(int pos){ JSONObject o=data.optJSONObject(pos); if(o==null)return;
              long id=o.optLong("id",-1);
              new AlertDialog.Builder(this).setTitle("Supprimer ?").setMessage(o.optString("name",""))
                .setPositiveButton("Supprimer",(d,w)->{ProfileManager.removeById(this,id);refresh();})
                .setNegativeButton("Annuler",null).show();
            }
          }
          EOF

          cat > app/src/main/java/com/worldtv/AddM3UActivity.java <<'EOF'
          package com.worldtv;
          import android.app.*; import android.os.*; import android.widget.*; import org.json.*;
          public class AddM3UActivity extends Activity {
            protected void onCreate(Bundle b){ super.onCreate(b); setContentView(R.layout.activity_add_m3u);
              EditText name=findViewById(R.id.ed_name), url=findViewById(R.id.ed_url);
              findViewById(R.id.btn_save).setOnClickListener(v->{ try{
                JSONObject o=new JSONObject(); o.put("id",System.currentTimeMillis()); o.put("type","M3U");
                o.put("name",name.getText().toString().trim()); o.put("url",url.getText().toString().trim());
                ProfileManager.addProfile(this,o); Toast.makeText(this,"Profil M3U ajouté",Toast.LENGTH_SHORT).show(); finish();
              }catch(Exception e){ Toast.makeText(this,e.getMessage(),Toast.LENGTH_LONG).show(); }});
            }
          }
          EOF

          cat > app/src/main/java/com/worldtv/AddXtreamActivity.java <<'EOF'
          package com.worldtv;
          import android.app.*; import android.os.*; import android.widget.*; import org.json.*;
          public class AddXtreamActivity extends Activity {
            protected void onCreate(Bundle b){ super.onCreate(b); setContentView(R.layout.activity_add_xtream);
              EditText n=findViewById(R.id.ed_name), h=findViewById(R.id.ed_host), u=findViewById(R.id.ed_user), p=findViewById(R.id.ed_pass);
              findViewById(R.id.btn_save).setOnClickListener(v->{ try{
                JSONObject o=new JSONObject(); o.put("id",System.currentTimeMillis()); o.put("type","XTREAM");
                o.put("name",n.getText().toString().trim()); o.put("host",h.getText().toString().trim());
                o.put("user",u.getText().toString().trim()); o.put("pass",p.getText().toString().trim());
                ProfileManager.addProfile(this,o); Toast.makeText(this,"Profil Xtream ajouté",Toast.LENGTH_SHORT).show(); finish();
              }catch(Exception e){ Toast.makeText(this,e.getMessage(),Toast.LENGTH_LONG).show(); }});
            }
          }
          EOF

          cat > app/src/main/java/com/worldtv/AddStbActivity.java <<'EOF'
          package com.worldtv;
          import android.app.*; import android.os.*; import android.widget.*; import org.json.*;
          public class AddStbActivity extends Activity {
            protected void onCreate(Bundle b){ super.onCreate(b); setContentView(R.layout.activity_add_stb);
              EditText n=findViewById(R.id.ed_name), portal=findViewById(R.id.ed_portal), mac=findViewById(R.id.ed_mac);
              findViewById(R.id.btn_save).setOnClickListener(v->{ try{
                JSONObject o=new JSONObject(); o.put("id",System.currentTimeMillis()); o.put("type","STB");
                o.put("name",n.getText().toString().trim()); o.put("portal",portal.getText().toString().trim()); o.put("mac",mac.getText().toString().trim());
                ProfileManager.addProfile(this,o); Toast.makeText(this,"Profil STB ajouté",Toast.LENGTH_SHORT).show(); finish();
              }catch(Exception e){ Toast.makeText(this,e.getMessage(),Toast.LENGTH_LONG).show(); }});
            }
          }
          EOF

          cat > app/src/main/java/com/worldtv/M3UChannelListActivity.java <<'EOF'
          package com.worldtv;
          import android.app.*; import android.os.*; import android.widget.*; import android.content.*; import java.net.*; import java.io.*; import java.nio.charset.StandardCharsets; import java.util.*;
          public class M3UChannelListActivity extends ListActivity {
            ArrayList<String[]> items=new ArrayList<>();
            protected void onCreate(Bundle b){ super.onCreate(b);
              String url=getIntent().getStringExtra("url");
              if(url==null||url.isEmpty()){ Toast.makeText(this,"URL M3U manquante",Toast.LENGTH_LONG).show(); finish(); return; }
              new Thread(()->{ try{
                HttpURLConnection c=(HttpURLConnection)new URL(url).openConnection(); c.setConnectTimeout(10000); c.setReadTimeout(20000);
                InputStream is=c.getInputStream(); String text=new String(is.readAllBytes(),StandardCharsets.UTF_8);
                items=M3UParser.parse(text); runOnUiThread(this::populate);
              }catch(Exception e){ runOnUiThread(()->{ Toast.makeText(this,"Erreur M3U: "+e.getMessage(),Toast.LENGTH_LONG).show(); finish();}); }}).start();
            }
            void populate(){ ArrayList<String> names=new ArrayList<>(); for(String[] it:items) names.add(it[0]);
              setListAdapter(new ArrayAdapter<>(this,android.R.layout.simple_list_item_1,names)); }
            protected void onListItemClick(ListView l, android.view.View v, int pos, long id){
              Intent i=new Intent(this, PlayerActivity.class); i.putExtra("url", items.get(pos)[1]); startActivity(i);
            }
          }
          EOF

          # Xtream minimal (catégories + chaînes LIVE)
          cat > app/src/main/java/com/worldtv/xtream/XtreamApi.java <<'EOF'
          package com.worldtv.xtream;
          import org.json.*; import java.net.*; import java.io.*; import java.nio.charset.StandardCharsets;
          public class XtreamApi {
            final String host,user,pass;
            public XtreamApi(String h,String u,String p){ host=h.endsWith("/")?h.substring(0,h.length()-1):h; user=u; pass=p; }
            String get(String url) throws Exception { HttpURLConnection c=(HttpURLConnection)new URL(url).openConnection();
              c.setConnectTimeout(15000); c.setReadTimeout(30000); try(InputStream is=c.getInputStream()){ return new String(is.readAllBytes(),StandardCharsets.UTF_8);} }
            public JSONArray getLiveCategories() throws Exception {
              String u=host+"/player_api.php?username="+URLEncoder.encode(user,"UTF-8")+"&password="+URLEncoder.encode(pass,"UTF-8")+"&action=get_live_categories";
              return new JSONArray(get(u));
            }
            public JSONArray getLiveStreams(String catId) throws Exception {
              String u=host+"/player_api.php?username="+URLEncoder.encode(user,"UTF-8")+"&password="+URLEncoder.encode(pass,"UTF-8")+"&action=get_live_streams&category_id="+URLEncoder.encode(catId,"UTF-8");
              return new JSONArray(get(u));
            }
            public String buildLiveUrl(int streamId){ return host+"/live/"+user+"/"+pass+"/"+streamId+".m3u8"; }
          }
          EOF

          cat > app/src/main/java/com/worldtv/xtream/XtreamLiveCategoriesActivity.java <<'EOF'
          package com.worldtv.xtream;
          import android.app.*; import android.os.*; import android.widget.*; import android.content.*; import org.json.*; import java.util.*;
          public class XtreamLiveCategoriesActivity extends ListActivity {
            XtreamApi api; ArrayList<String> names=new ArrayList<>(), ids=new ArrayList<>();
            protected void onCreate(Bundle b){ super.onCreate(b);
              api=new XtreamApi(getIntent().getStringExtra("host"), getIntent().getStringExtra("user"), getIntent().getStringExtra("pass"));
              new Thread(()->{ try{
                JSONArray arr=api.getLiveCategories(); names.clear(); ids.clear();
                for(int i=0;i<arr.length();i++){ JSONObject o=arr.optJSONObject(i); if(o==null)continue;
                  names.add(o.optString("category_name","Sans nom")); ids.add(o.optString("category_id","0")); }
                runOnUiThread(()-> setListAdapter(new ArrayAdapter<>(this,android.R.layout.simple_list_item_1,names)));
              }catch(Exception e){ runOnUiThread(()->{ Toast.makeText(this,"Xtream Catégories: "+e.getMessage(),Toast.LENGTH_LONG).show(); finish();}); }}).start();
            }
            protected void onListItemClick(ListView l, android.view.View v, int pos, long id){
              Intent i=new Intent(this, XtreamLiveChannelsActivity.class);
              i.putExtra("host", getIntent().getStringExtra("host"));
              i.putExtra("user", getIntent().getStringExtra("user"));
              i.putExtra("pass", getIntent().getStringExtra("pass"));
              i.putExtra("catId", ids.get(pos)); startActivity(i);
            }
          }
          EOF

          cat > app/src/main/java/com/worldtv/xtream/XtreamLiveChannelsActivity.java <<'EOF'
          package com.worldtv.xtream;
          import android.app.*; import android.os.*; import android.widget.*; import android.content.*; import org.json.*; import java.util.*;
          public class XtreamLiveChannelsActivity extends ListActivity {
            XtreamApi api; ArrayList<String> names=new ArrayList<>(); ArrayList<Integer> ids=new ArrayList<>();
            protected void onCreate(Bundle b){ super.onCreate(b);
              api=new XtreamApi(getIntent().getStringExtra("host"), getIntent().getStringExtra("user"), getIntent().getStringExtra("pass"));
              String catId=getIntent().getStringExtra("catId");
              new Thread(()->{ try{
                JSONArray arr=api.getLiveStreams(catId); names.clear(); ids.clear();
                for(int i=0;i<arr.length();i++){ JSONObject o=arr.optJSONObject(i); if(o==null)continue;
                  names.add(o.optString("name","Sans nom")); ids.add(o.optInt("stream_id",0)); }
                runOnUiThread(()-> setListAdapter(new ArrayAdapter<>(this,android.R.layout.simple_list_item_1,names)));
              }catch(Exception e){ runOnUiThread(()->{ Toast.makeText(this,"Xtream Streams: "+e.getMessage(),Toast.LENGTH_LONG).show(); finish();}); }}).start();
            }
            protected void onListItemClick(ListView l, android.view.View v, int pos, long id){
              String url=api.buildLiveUrl(ids.get(pos));
              Intent i=new Intent(this, com.worldtv.PlayerActivity.class); i.putExtra("url", url); startActivity(i);
            }
          }
          EOF

          # Player
          cat > app/src/main/java/com/worldtv/PlayerActivity.java <<'EOF'
          package com.worldtv;
          import android.net.*; import android.os.*; import androidx.appcompat.app.AppCompatActivity;
          import androidx.media3.common.*; import androidx.media3.exoplayer.ExoPlayer; import androidx.media3.ui.PlayerView;
          public class PlayerActivity extends AppCompatActivity {
            private ExoPlayer player;
            protected void onCreate(Bundle b){ super.onCreate(b); setContentView(R.layout.activity_player);
              String url=getIntent().getStringExtra("url");
              if(url==null||url.isEmpty()) url="https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8";
              player=new ExoPlayer.Builder(this).build();
              PlayerView pv=findViewById(R.id.player_view); pv.setPlayer(player);
              player.setMediaItem(MediaItem.fromUri(Uri.parse(url))); player.prepare(); player.play();
            }
            protected void onDestroy(){ super.onDestroy(); if(player!=null){ player.release(); player=null; } }
          }
          EOF

      - name: Build Debug APK
        run: gradle --no-build-cache assembleDebug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: WorldTV-debug-apk
          path: app/build/outputs/apk/debug/*.apk
